
name: Telegram Live Stream

on:
  repository_dispatch:
    types: [start_stream]
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Video URL'
        required: true
      rtmp_url:
        description: 'RTMP URL'
        required: true
      alist_token:
        description: 'Alist Token'
        required: false

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # æœ€é•¿è¿è¡Œ 6 å°æ—¶

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Check Connectivity (Debug)
      env:
        VIDEO_URL: ${{ github.event.client_payload.video_url || inputs.video_url }}
      run: |
        echo "ğŸ” æ­£åœ¨æ£€æŸ¥è§†é¢‘é“¾æ¥è¿é€šæ€§..."
        # éšè—éƒ¨åˆ† URL å‚æ•°ä»¥é˜²æ³„éœ² Token
        DISPLAY_URL=$(echo "$VIDEO_URL" | sed 's/token=[^&]*/token=***/')
        echo "URL: $DISPLAY_URL"
        
        # ä½¿ç”¨ curl æ£€æŸ¥ (è·Ÿéšé‡å®šå‘)
        if curl -I -L --fail --connect-timeout 10 "$VIDEO_URL"; then
            echo "âœ… é“¾æ¥å¯ç”¨"
        else
            echo "âš ï¸  Curl æ£€æŸ¥å¤±è´¥ï¼Œå°è¯•è·å–è¯¦ç»†å“åº”ä»¥æ’æŸ¥é”™è¯¯ (å¦‚ 401/403/530)..."
            curl -v -L --connect-timeout 10 "$VIDEO_URL" || true
        fi

    - name: Start Streaming
      env:
        # âš¡ï¸ æ ¸å¿ƒä¿®å¤: ä½¿ç”¨ GitHub è¡¨è¾¾å¼ (||) å¤„ç†å˜é‡
        VIDEO_URL: ${{ github.event.client_payload.video_url || inputs.video_url }}
        RTMP_URL: ${{ github.event.client_payload.rtmp_url || inputs.rtmp_url }}
        # ALIST_TOKEN ä¸å†éœ€è¦æ³¨å…¥ Headerï¼Œå› æ­¤è¿™é‡Œä¸å†ä½¿ç”¨
      run: |
        echo "---------------------------------------------------"
        echo "ğŸš€ ä»»åŠ¡å¯åŠ¨ç¡®è®¤"
        echo "ğŸ“º æ¨æµç›®æ ‡: RTMP Server"
        echo "---------------------------------------------------"

        if [[ -z "$VIDEO_URL" ]] || [[ -z "$RTMP_URL" ]]; then
          echo "âŒ è‡´å‘½é”™è¯¯: å˜é‡è¯»å–å¤±è´¥ï¼Œåœ°å€ä¸ºç©ºï¼"
          exit 1
        fi

        # æ„å»º FFmpeg å‘½ä»¤æ•°ç»„
        CMD=(ffmpeg -re)
        
        # --- ç½‘ç»œæŠ—æ³¢åŠ¨é…ç½® (å…³é”®) ---
        CMD+=(-reconnect 1)
        CMD+=(-reconnect_at_eof 1)
        CMD+=(-reconnect_streamed 1)
        CMD+=(-reconnect_on_http_error 4xx,5xx)
        CMD+=(-reconnect_delay_max 30)
        
        # å¢åŠ åè®®ç™½åå•
        CMD+=(-protocol_whitelist file,http,https,tcp,tls,crypto)
        
        CMD+=(-rw_timeout 15000000)
        CMD+=(-user_agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64)")

        # âš¡ï¸ ç§»é™¤: Header æ³¨å…¥é€»è¾‘
        # å› ä¸º Bot ç°åœ¨ä¼šç”Ÿæˆå¸¦ Token æˆ–ç­¾åçš„ URLï¼ŒFFmpeg ä¸å†éœ€è¦ Headerã€‚
        # å‘é€ Authorization Header ç»™ PikPak/OSS ä¼šå¯¼è‡´ 401 é”™è¯¯ã€‚

        # è¾“å…¥ä¸è¾“å‡º
        CMD+=(-i "$VIDEO_URL")
        CMD+=(-c:v copy -c:a aac -ar 44100 -b:a 128k -ac 2)
        CMD+=(-f flv "$RTMP_URL")

        echo "â–¶ï¸ å¼€å§‹è¿è¡Œ FFmpeg..."
        "${CMD[@]}"
