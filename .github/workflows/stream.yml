
name: Telegram Live Stream

on:
  repository_dispatch:
    types: [start_stream]

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 最长运行 6 小时

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Start Streaming
      env:
        VIDEO_URL: ${{ github.event.client_payload.video_url }}
        RTMP_URL: ${{ github.event.client_payload.rtmp_url }}
        ALIST_TOKEN: ${{ github.event.client_payload.alist_token }}
      run: |
        echo "开始推流..."
        echo "源地址: $VIDEO_URL"
        echo "目标: TG 直播服务器"
        
        # 构建 Headers 参数
        # 注意：FFmpeg -headers 参数需要严格格式 (Key: Value\r\n)
        HEADERS_OPTS=""
        if [ -n "$ALIST_TOKEN" ]; then
             # 添加 User-Agent 和 Authorization
             HEADERS_OPTS="-headers Authorization: $ALIST_TOKEN"
        fi
        
        # 使用 FFmpeg 推流
        # -re: 按原速率读取
        # -reconnect 1: 尝试断线重连 (对 HTTP 530/502 有一定抵抗力)
        # -reconnect_at_eof 1: 文件结束时尝试重连 (防止过早断开)
        # -reconnect_streamed 1: 流式重连
        # -reconnect_delay_max 5: 最大重连等待
        
        ffmpeg $HEADERS_OPTS -user_agent "Mozilla/5.0" -re \
          -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
          -i "$VIDEO_URL" \
          -c:v copy \
          -c:a aac -ar 44100 -b:a 128k -ac 2 \
          -f flv "$RTMP_URL"
