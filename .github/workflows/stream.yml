
name: Telegram Live Stream

on:
  # 1. å…è®¸ Bot é€šè¿‡ API è§¦å‘
  repository_dispatch:
    types: [start_stream]
  
  # 2. å…è®¸åœ¨ GitHub ç½‘é¡µæ‰‹åŠ¨ç‚¹å‡» "Run workflow" (ç”¨äºæµ‹è¯•æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ)
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Video URL'
        required: true
      rtmp_url:
        description: 'RTMP URL'
        required: true
      alist_token:
        description: 'Alist Token (Optional)'
        required: false

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # æœ€é•¿è¿è¡Œ 6 å°æ—¶

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Start Streaming
      run: |
        # --- 1. å‚æ•°è§£æ ---
        if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
          # æ¥è‡ª Bot API çš„å‚æ•°
          VIDEO="${{ github.event.client_payload.video_url }}"
          RTMP="${{ github.event.client_payload.rtmp_url }}"
          TOKEN="${{ github.event.client_payload.alist_token }}"
        else
          # æ¥è‡ªç½‘é¡µæ‰‹åŠ¨çš„å‚æ•°
          VIDEO="${{ inputs.video_url }}"
          RTMP="${{ inputs.rtmp_url }}"
          TOKEN="${{ inputs.alist_token }}"
        fi

        echo "---------------------------------------------------"
        echo "ğŸš€ å¯åŠ¨æ¨æµä»»åŠ¡"
        echo "ğŸ“¡ è§†é¢‘æº: $VIDEO"
        echo "ğŸ“º æ¨æµè‡³: TG ç›´æ’­æœåŠ¡å™¨"
        echo "---------------------------------------------------"

        if [[ -z "$VIDEO" ]] || [[ -z "$RTMP" ]]; then
          echo "âŒ é”™è¯¯: è§†é¢‘åœ°å€æˆ–æ¨æµåœ°å€ä¸ºç©ºï¼"
          exit 1
        fi

        # --- 2. æ„å»º FFmpeg å‘½ä»¤ ---
        # ä½¿ç”¨ Bash æ•°ç»„æ„å»ºå‘½ä»¤ï¼Œå®‰å…¨å¤„ç†å¸¦ç©ºæ ¼çš„å‚æ•°å’Œ Header
        CMD=(ffmpeg -re)

        # ç½‘ç»œç¨³å®šæ€§å‚æ•°
        # -reconnect 1: æ–­çº¿é‡è¿
        # -reconnect_at_eof 1: é‡åˆ° EOF å°è¯•é‡è¿ (é˜²æ­¢è¿‡æ—©ç»“æŸ)
        # -reconnect_streamed 1: é’ˆå¯¹æµåª’ä½“é‡è¿
        # -rw_timeout 15000000: è¯»å†™è¶…æ—¶ 15ç§’
        CMD+=(-reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5)
        CMD+=(-rw_timeout 15000000)
        CMD+=(-user_agent "Mozilla/5.0")

        # é‰´æƒ Headers (å¦‚æœæœ‰ Token)
        if [[ -n "$TOKEN" ]]; then
           echo "ğŸ”‘ å·²æ·»åŠ è®¤è¯ Token"
           CMD+=(-headers "Authorization: $TOKEN")
        fi

        # è¾“å…¥é…ç½®
        CMD+=(-i "$VIDEO")

        # è¾“å‡ºé…ç½®
        # -c:v copy: è§†é¢‘æµç›´æ¥å¤åˆ¶ (ä¸è½¬ç ï¼ŒèŠ‚çœ CPU)
        # -c:a aac: éŸ³é¢‘è½¬ç ä¸º aac (ä¿è¯å…¼å®¹æ€§)
        CMD+=(-c:v copy -c:a aac -ar 44100 -b:a 128k -ac 2)
        CMD+=(-f flv "$RTMP")

        # --- 3. æ‰§è¡Œæ¨æµ ---
        echo "â–¶ï¸ æ‰§è¡Œ FFmpeg..."
        # "${CMD[@]}" ä¼šæ­£ç¡®å±•å¼€æ•°ç»„ä¸­çš„å‚æ•°
        "${CMD[@]}"
