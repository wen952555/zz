
name: Telegram Live Stream

on:
  repository_dispatch:
    types: [start_stream]

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 最长运行 6 小时

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Start Streaming
      env:
        VIDEO_URL: ${{ github.event.client_payload.video_url }}
        RTMP_URL: ${{ github.event.client_payload.rtmp_url }}
        ALIST_TOKEN: ${{ github.event.client_payload.alist_token }}
      run: |
        echo "开始推流..."
        echo "源地址: $VIDEO_URL"
        echo "目标: TG 直播服务器"
        
        # 构建 Headers
        # 即使文件需要密码，带上 Authorization 头也能直接读取
        HEADERS=""
        if [ -n "$ALIST_TOKEN" ]; then
             HEADERS="Authorization: $ALIST_TOKEN"
        fi
        
        # 使用 FFmpeg 推流
        # -headers: 添加认证头 (必须在 -i 之前)
        # -user_agent: 伪装 UA 防止拦截
        # -re: 按原速率读取 (模拟直播)
        # -c:v copy: 视频流直接复制
        # -c:a aac: 音频转码为 AAC
        
        ffmpeg -headers "$HEADERS" -user_agent "Mozilla/5.0" -re -i "$VIDEO_URL" \
          -c:v copy \
          -c:a aac -ar 44100 -b:a 128k -ac 2 \
          -f flv "$RTMP_URL"
